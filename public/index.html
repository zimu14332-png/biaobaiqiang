<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>表白墙 - 首页</title>
  <link href="https://vjs.zencdn.net/8.14.1/video-js.css" rel="stylesheet" />
  <style>
    :root {
      --pink: #ff6b81;
      --bg: #f7f7fb;
      --card: #ffffff;
      --text: #222;
      --muted: #666;
      --border: #e0e0e6;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Microsoft YaHei', sans-serif; background: linear-gradient(180deg, #fff0f5, #ffe6ef); color: var(--text); }
    header { position: sticky; top: 0; z-index: 10; background: var(--pink); color: white; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between; }
    header a { color: white; text-decoration: none; font-weight: 700; }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; box-shadow: 0 6px 18px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
    .media { width: 100%; height: 220px; background: #f1f1f4; display: grid; place-items: center; overflow: hidden; }
    .media img, .media video { width: 100%; height: 100%; object-fit: cover; display: block; }
    .info { padding: 12px 14px; display: grid; gap: 6px; }
    .title { font-weight: 800; }
    .desc { color: var(--muted); font-size: 13px; line-height: 1.4; }
    .time { color: var(--muted); font-size: 12px; }
    .empty { text-align: center; color: var(--muted); margin-top: 40px; }
  </style>
</head>
<body>
  <header>
    <a href="/">表白墙</a>
    <a href="/upload">发布</a>
  </header>
  <div class="container">
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" style="display:none">暂无内容，去“发布”上传吧～</div>
  </div>

  <script src="https://vjs.zencdn.net/8.14.1/video.min.js"></script>
  <script>
    function formatTime(ts){
      try { return new Date(ts).toLocaleString(); } catch { return '' }
    }

    function createCard(item) {
      const el = document.createElement('div');
      el.className = 'card';
      el.style.cursor = 'pointer';

      const media = document.createElement('div');
      media.className = 'media';

      if (item.type === 'video') {
        const v = document.createElement('video');
        v.className = 'video-js vjs-default-skin';
        v.setAttribute('controls', '');
        v.setAttribute('preload', 'metadata');
        v.setAttribute('playsinline', '');
        const source = document.createElement('source');
        source.src = item.url;
        if (item.mimeType) source.type = item.mimeType;
        v.appendChild(source);
        media.appendChild(v);
        // Initialize Video.js player
        try { window.videojs && window.videojs(v, { controls: true, preload: 'metadata', fluid: true }); } catch (e) {}
      } else {
        const img = document.createElement('img');
        img.src = item.url;
        img.loading = 'lazy';
        media.appendChild(img);
      }

      const info = document.createElement('div');
      info.className = 'info';

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = `${item.className} · ${item.personName}`;

      const desc = document.createElement('div');
      desc.className = 'desc';
      desc.textContent = item.description || '';

      const time = document.createElement('div');
      time.className = 'time';
      time.textContent = formatTime(item.uploadedAt);

      info.appendChild(title);
      if (item.description) info.appendChild(desc);
      info.appendChild(time);

      el.appendChild(media);
      el.appendChild(info);

      // Navigate to detail when clicking the card (except when interacting with video controls)
      const goDetail = () => {
        if (!item.id) return;
        location.href = '/detail?id=' + encodeURIComponent(item.id);
      };
      el.addEventListener('click', (e) => {
        if (e.target.closest('video') || e.target.closest('button') || e.target.closest('a') || e.target.closest('input')) return;
        goDetail();
      });
      el.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') goDetail();
      });
      return el;
    }

    async function load(){
      const res = await fetch('/api/items');
      const json = await res.json();
      const list = document.getElementById('list');
      const empty = document.getElementById('empty');
      list.innerHTML = '';
      if (!json.items || json.items.length === 0) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      json.items.forEach(item => list.appendChild(createCard(item)));
    }

    load();
  </script>
</body>
</html>
